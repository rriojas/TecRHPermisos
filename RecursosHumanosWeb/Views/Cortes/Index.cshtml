@model RecursosHumanosWeb.Models.ViewModels.SearchCorteViewModel
@using System.Security.Claims
@using X.PagedList.Mvc.Core

@{
    ViewData["Title"] = "Gestión de Cortes";
    bool isAdministrador = Model.IsAdministrador;
    bool isRecursosHumanos = (bool)ViewData["IsRH"]!;
}

@section Styles {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="~/css/Cortes/Index.css" rel="stylesheet" />
    <!-- Eliminamos la referencia a dataTables.dataTables.min.css -->
}

<div class="index-container">
    <!-- Header Section -->
    <div class="page-header fade-in">
        <div class="header-content">
            <h1 class="page-title text-gradient">
                <i class="fas fa-calendar-alt"></i>
                Gestión de Cortes
            </h1>
            <p class="page-subtitle">Administra los períodos de corte del sistema</p>
        </div>
        @if (isAdministrador || isRecursosHumanos)
        {
            <div class="header-actions">
                <a asp-action="Create" class="btn btn-create" aria-label="Crear nuevo corte">
                    <i class="fas fa-plus"></i>
                    Crear Corte
                </a>
            </div>
        }
    </div>

    <!-- Filters Section -->
    <div class="filters-section slide-in-left">
        <div class="card">
            <form id="searchForm" method="get" asp-action="Index">
                @Html.AntiForgeryToken()
                <div class="row">
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label for="usuarioCreadorFilter">
                                <i class="fas fa-user-plus" style="color: var(--accent-indigo);"></i>
                                Creado por
                            </label>
                            <select id="usuarioCreadorFilter" name="usuarioCreadorFilter" class="form-control user-autocomplete" data-user-value="id" aria-label="Usuario creador" style="width:100%">
                                <option value="">Todos los usuarios</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label for="statusFilter">
                                <i class="fas fa-info-circle" style="color: var(--accent-slate);"></i>
                                Estatus
                            </label>
                            <select id="statusFilter" name="statusFilter" class="form-control" aria-label="Estatus">
                                <option value="" selected="@(string.IsNullOrEmpty(ViewBag.StatusFilter?.ToString()) ? "selected" : null)">Todos los estatus</option>
                                <option value="true" selected="@(ViewBag.StatusFilter is true ? "selected" : null)">Activo</option>
                                <option value="false" selected="@(ViewBag.StatusFilter is false ? "selected" : null)">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <button type="submit" class="btn btn-search">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                            <button type="button" onclick="clearAllFilters()" class="btn btn-clear">
                                <i class="fas fa-refresh"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Table Section -->
    <div class="table-container fade-in mb-5">
        <div class="card">
            <div class="table-inner">
                <div class="overflow-x-auto">
                    <table id="cortesTable" class="data-table" style="width:100%" aria-label="Tabla de cortes">
                        <thead>
                            <tr>
                                <th class="text-center">Inicia</th>
                                <th class="text-center">Termina</th>
                                <th class="text-center">Creación</th>
                                <th class="text-center">Modificación</th>
                                <th class="text-center">Estatus</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Cortes)
                            {
                                var usuarioCrea = Model.Usuarios.FirstOrDefault(u => u.Id == item.IdUsuarioCrea)?.Nombre ?? "-";
                                var usuarioModifica = Model.Usuarios.FirstOrDefault(u => u.Id == item.IdUsuarioModifica)?.Nombre ?? "-";
                                <tr>
                                    <td>@(item.Inicia?.ToString("dd/MM/yyyy") ?? "-")</td>
                                    <td>@(item.Termina?.ToString("dd/MM/yyyy") ?? "-")</td>
                                    <td>
                                        @if (item.FechaCreacion.HasValue)
                                        {
                                            <div style="color: var(--text-medium); font-weight: 500;">
                                                <div style="font-size: 0.875rem;">@item.FechaCreacion.Value.ToString("dd/MM/yyyy")</div>
                                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.125rem;">@item.FechaCreacion.Value.ToString("h:mm tt")</div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div style="font-style: italic; color: var(--text-muted);">Sin crear</div>
                                        }
                                    </td>
                                    <td>
                                        @if (item.FechaModificacion.HasValue)
                                        {
                                            <div style="color: var(--text-medium); font-weight: 500;">
                                                <div style="font-size: 0.875rem;">@item.FechaModificacion.Value.ToString("dd/MM/yyyy")</div>
                                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.125rem;">@item.FechaModificacion.Value.ToString("h:mm tt")</div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div style="font-style: italic; color: var(--text-muted);">Sin modificar</div>
                                        }
                                    </td>
                                    <td class="@(item.Estatus ? "status-cell-active" : "status-cell-inactive")">
                                        @(item.Estatus ? "Activo" : "Inactivo")
                                    </td>
                           
                                    <td class="text-center">
                                        <div class="flex justify-center gap-2">
                                            @if (isAdministrador)
                                            {
                                                <a href="#" class="action-btn btn-delete" title="Eliminar" aria-label="Eliminar corte" data-action="Delete" data-controller="Cortes" data-id="@item.Id">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            }
                                            <a asp-action="Details" asp-route-id="@item.Id" class="action-btn btn-view" title="Ver detalles" aria-label="Ver detalles del corte">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-center">Inicia</th>
                                <th class="text-center">Termina</th>
                                <th class="text-center">Creación</th>
                                <th class="text-center">Modificación</th>
                                <th class="text-center">Estatus</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </tfoot>
                    </table>
                   
                </div>

                <!-- Control de paginación con PagedList -->
                @if (Model.Cortes.Any())
                {
                    <!-- Paginación -->
                    <div class="pagination-container">
                        <div class="pagination-info">
                            Mostrando @Model.Cortes.FirstItemOnPage - @Model.Cortes.LastItemOnPage de @Model.Cortes.TotalItemCount cortes
                        </div>

                        @Html.PagedListPager(
                        Model.Cortes,
                                        page => Url.Action("Index", new
                                        {
                                            page,
                                            sortOrder = ViewBag.CurrentSort,
                                            nombreFilter = ViewBag.NombreFilter,
                                            correoFilter = ViewBag.CorreoFilter,
                                            departamentoFilter = ViewBag.DepartamentoFilter,
                                            estadoFilter = ViewBag.EstadoFilter
                                        }),
                                        new PagedListRenderOptions
                                        {
                                            DisplayLinkToFirstPage = PagedListDisplayMode.Always,
                                            DisplayLinkToLastPage = PagedListDisplayMode.Always,
                                            DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
                                            DisplayLinkToNextPage = PagedListDisplayMode.Always,
                                            DisplayLinkToIndividualPages = true,
                                            MaximumPageNumbersToDisplay = 5,
                                            DisplayEllipsesWhenNotShowingAllPageNumbers = true,
                                            UlElementClasses = new[] { "pagination" },
                                            LiElementClasses = new[] { "page-item" },
                                            PageClasses = new[] { "page-link" }
                                        })
                </div>
                                }
            </div>
        </div>
    </div>

    <!-- Empty State -->
    @if (!Model.Cortes.Any())
    {
        <div class="empty-state fade-in">
            <div class="empty-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <h3>No hay cortes registrados</h3>
            <p class="text-muted">Intenta ajustar los filtros de búsqueda</p>
        </div>
    }
</div>

@section Scripts {
    <script>
        (function(){
            // Inicializar select2 en el select de usuarios para búsqueda remota
            $(document).ready(function(){
                $('#usuarioCreadorFilter').select2({
                    placeholder: '-- Seleccionar Usuario --',
                    minimumInputLength: 2,
                    allowClear: true,
                    ajax: {
                        url: '/Usuarios/SearchUsers',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return { term: params.term };
                        },
                        processResults: function (data) {
                            return { results: data };
                        },
                        cache: true
                    }
                });

                // Abrir el dropdown automáticamente al recibir foco para poder escribir inmediatamente
                $('#usuarioCreadorFilter').on('focus', function () {
                    $(this).select2('open');
                });

                // Asegurar que el campo de búsqueda interno reciba foco cuando se abra
                $('#usuarioCreadorFilter').on('select2:open', function () {
                    const searchField = document.querySelector('.select2-container--open .select2-search__field');
                    if (searchField) searchField.focus();
                });
            });
        })();
        function clearAllFilters() {
            document.getElementById('usuarioCreadorFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchForm').submit();
            // Usar helper global
            if (typeof showToast === 'function') showToast('✅ Todos los filtros han sido limpiados', 'success');
            else showNotification('✅ Todos los filtros han sido limpiados', 'success');
        }

        function showNotification(message, type = 'info') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                },
                customClass: {
                    popup: 'swal-popup-custom',
                    title: 'swal-title-custom'
                }
            });
            Toast.fire({ icon: type, title: message });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const elements = document.querySelectorAll('.fade-in, .slide-in-left');
            elements.forEach(element => {
                element.style.opacity = '0';
                element.style.transform = element.classList.contains('slide-in-left')
                    ? 'translateX(-30px)'
                    : 'translateY(20px)';
            });

            setTimeout(() => {
                elements.forEach((element, index) => {
                    setTimeout(() => {
                        element.style.transition = 'all 0.6s ease-out';
                        element.style.opacity = '1';
                        element.style.transform = 'translate(0, 0)';
                    }, index * 150);
                });
            }, 100);
        });
    </script>
}