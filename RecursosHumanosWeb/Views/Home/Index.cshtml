@using RecursosHumanosWeb.Models.DTOs
@using RecursosHumanosWeb.Models.ViewModels
@using X.PagedList
@using X.PagedList.Mvc.Core

@model SearchPermissionsViewModel

@{
    ViewData["Title"] = "Gestión de Permisos";
    bool isAutorizador = ViewBag.IsAutorizador;
    bool isRH = ViewBag.IsRH;
    bool isAdministrador = ViewBag.IsAdministrador;
    bool isEmpleado = ViewBag.IsEmpleado;
}

@section Styles {
    <link rel="stylesheet" href="~/css/Permisos/search.css" asp-append-version="true" />
}

<div class="permisos-container">
    <!-- Header Section -->
    <div class="page-header fade-in">
        <div class="header-content">
            <h1 class="page-title text-gradient">
                <i class="fas fa-calendar-alt"></i>
                Gestión de Permisos
            </h1>
            <p class="page-subtitle">Administra y supervisa los permisos del personal</p>
        </div>
        @if (!isAutorizador)
        {
            <div class="header-actions">
                <a asp-action="Create" class="btn btn-primary btn-create">
                    <i class="fas fa-plus"></i>
                    Nuevo Permiso
                </a>
            </div>
        }
    </div>

    <!-- Filters Section -->
    <div class="filters-section slide-in-left">
        <div class="filters-card">
            <form id="searchForm" method="get" asp-action="GetPermisos">
                @Html.AntiForgeryToken()
                <div class="row">
                    <!-- Date Filters -->
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label for="delDia">Desde:</label>
                            <input type="date" id="delDia" name="delDia" class="form-control" value="@ViewBag.DelDia" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label for="alDia">Hasta:</label>
                            <input type="date" id="alDia" name="alDia" class="form-control" value="@ViewBag.AlDia" />
                        </div>
                    </div>

                    @if (isRH || isAdministrador || isAutorizador)
                    {
                        <!-- User Filter -->
                        <div class="col-md-3" id="userFilterContainer">
                            <div class="filter-group">
                                <label for="nombreUsuario">Usuario:</label>
                                <select id="nombreUsuario" name="nombreUsuario" class="form-control user-autocomplete" data-user-value="text">
                                    <option value="">-- Seleccionar Usuario --</option>
                                    @foreach (var usuario in Model.Usuarios)
                                    {
                                        if (usuario.Nombre == Model.SelectedUser)
                                        {
                                            <option value="@usuario.Nombre" data-area-id="@usuario.IdArea" selected>@usuario.Nombre</option>
                                        }
                                        else
                                        {
                                            <option value="@usuario.Nombre" data-area-id="@usuario.IdArea">@usuario.Nombre</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    }

                    @if (isRH || isAdministrador)
                    {
                        <!-- Area Filter -->
                        <div class="col-md-3" id="areaFilterContainer">
                            <div class="filter-group">
                                <label for="idArea">Área:</label>
                                <select id="idArea" name="idArea" class="form-control">
                                    <option value="">-- Seleccionar Área --</option>
                                    @foreach (var area in Model.Areas)
                                    {
                                        if (area.Id == Model.SelectedArea)
                                        {
                                            <option value="@area.Id" selected>@area.Descripcion</option>
                                        }
                                        else
                                        {
                                            <option value="@area.Id">@area.Descripcion</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    }
                </div>

                <!-- Permission Type Filters -->
                <div class="row mt-3">
                    <div class="col-md-8">
                        <div class="filter-group">
                            <label>Tipo de Permiso:</label>
                            <div class="radio-group">
                                <input type="radio" id="rbFalta" name="idTipoPermisos" value="2" @(ViewBag.SelectedTipo == "2" ? "checked" : "") />
                                <label for="rbFalta">Falta</label>
                                <input type="radio" id="rbRetardo" name="idTipoPermisos" value="3" @(ViewBag.SelectedTipo == "3" ? "checked" : "") />
                                <label for="rbRetardo">Retardo</label>
                                <input type="radio" id="rbCambioDeTurno" name="idTipoPermisos" value="4" @(ViewBag.SelectedTipo == "4" ? "checked" : "") />
                                <label for="rbCambioDeTurno">Cambio de Turno</label>
                                <input type="radio" id="rbTurnoPorTurno" name="idTipoPermisos" value="5" @(ViewBag.SelectedTipo == "5" ? "checked" : "") />
                                <label for="rbTurnoPorTurno">Turno por Turno</label>
                                <input type="radio" id="rbNinguno" name="idTipoPermisos" value="" @(string.IsNullOrEmpty(ViewBag.SelectedTipo) ? "checked" : "") />
                                <label for="rbNinguno">Todos</label>
                            </div>
                        </div>
                    </div>

                    <!-- Search and Clear Buttons -->
                    <div class="col-md-4">
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <button type="submit" class="btn btn-primary btn-search">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                            <button type="button" id="btnClear" class="btn btn-secondary">
                                <i class="fas fa-refresh"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Hidden Inputs for Pagination -->
                <input type="hidden" id="pageNumber" name="pageNumber" value="1" />
                <input type="hidden" id="pageSize" name="pageSize" value="5" />

                <!-- Error Message Display -->
                @if (ViewData["ErrorMessage"] != null)
                {
                    <div class="error-message text-danger">@ViewData["ErrorMessage"]</div>
                }
            </form>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid fade-in">
        <div class="stat-card stat-total">
            <div class="stat-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="stat-content">
                <h3 id="totalPermisos">@Model.Permisos?.Count()</h3>
                <p>Total</p>
            </div>
        </div>
        <div class="stat-card stat-pending">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <h3 id="pendingPermisos">@Model.Permisos?.Count(p => p.Estatus && p.FechaAutorizacion == null)</h3>
                <p>Pendientes</p>
            </div>
        </div>
        <div class="stat-card stat-approved">
            <div class="stat-icon">
                <i class="fas fa-check"></i>
            </div>
            <div class="stat-content">
                <h3 id="approvedPermisos">@Model.Permisos?.Count(p => p.FechaAutorizacion != null)</h3>
                <p>Aprobados</p>
            </div>
        </div>
        <div class="stat-card stat-rejected">
            <div class="stat-icon">
                <i class="fas fa-times"></i>
            </div>
            <div class="stat-content">
                <h3 id="rejectedPermisos">@Model.Permisos?.Count(p => !p.Estatus)</h3>
                <p>Rechazados</p>
            </div>
        </div>
    </div>

    <!-- Permisos Grid -->
    <div class="permisos-grid" id="permisosGrid">
        @foreach (var item in Model.Permisos ?? Enumerable.Empty<PermisosDTO>())
        {
            var status = item.Estatus ? (item.FechaAutorizacion == null ? "Pendiente" : "Aprobado") : "Rechazado";
            var statusClass = status switch
            {
                "Pendiente" => "status-pending",
                "Aprobado" => "status-approved",
                "Rechazado" => "status-rejected",
                _ => ""
            };
            var tipoPermiso = item.IdTipoPermiso switch
            {
                2 => ("Falta", "fa-user-clock"),
                3 => ("Retardo", "fa-clock"),
                4 => ("Cambio de Horario", "fa-exchange-alt"),
                5 => ("Turno por Turno", "fa-exchange-alt"),
                _ => ("Desconocido", "fa-question")
            };

            var config = new Dictionary<int, (bool showFecha1, string labelFecha1, bool showFecha2, string labelFecha2, bool showHora1, string labelHora1, bool showHora2, string labelHora2)>
            {
                [2] = (true, "Del día", true, "Al día", false, "Hora entrada", false, "Hora salida"),
                [3] = (true, "En el día", false, "Al día", true, "Hora de entrada", false, "Hora salida"),
                [4] = (true, "Del día", true, "Al día", true, "Hora entrada", true, "Hora salida"),
                [5] = (true, "Del día", true, "Por el día", true, "Hora entrada", true, "Hora salida")
            };

            var (showFecha1, labelFecha1, showFecha2, labelFecha2, showHora1, labelHora1, showHora2, labelHora2) = config[item.IdTipoPermiso];

            <div class="permiso-card" data-status="@status" data-type="@item.IdTipoPermiso">
                <!-- Card Header -->
                <div class="card-header">
                    <div class="employee-info">
                        <div class="employee-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="employee-details">
                            <h3>@(item.Nombre ?? "Sin Nombre")</h3>
                            <div class="employee-id">ID: @(item.IdUsuarioSolicita.ToString() ?? "Sin ID")</div>
                        </div>
                    </div>
                    <div class="header-badges">
                        <div class="status-badge @statusClass">
                            <i class="fas @(status == "Pendiente" ? "fa-clock" : status == "Aprobado" ? "fa-check-circle" : "fa-times-circle")"></i>
                            @status
                        </div>
                        @if (!string.IsNullOrEmpty(item.Evidencia))
                        {
                            <a href="#" class="pdf-attachment has-pdf" onclick="openPDF('@item.Evidencia')">
                                <i class="fas fa-file-pdf pdf-icon"></i>
                                PDF
                            </a>
                        }
                        else
                        {
                            <div class="pdf-attachment no-pdf">
                                <i class="fas fa-file-pdf pdf-icon"></i>
                                Sin PDF
                            </div>
                        }
                    </div>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <div class="permission-type-header">
                        <div class="type-icon">
                            <i class="fas @tipoPermiso.Item2"></i>
                        </div>
                        <div class="type-details">
                            <h4>@tipoPermiso.Item1</h4>
                        </div>
                    </div>
                    <div class="permission-details">
                        <!-- Fechas -->
                        <div class="detail-row">
                            @if (showFecha1 && item.Fecha1.HasValue)
                            {
                                <div class="detail-item">
                                    <label>@labelFecha1:</label>
                                    <span class="date-value">@item.Fecha1.Value.ToString("dddd dd \\de MMMM \\del yyyy")</span>
                                    @if (showHora1 && item.Fecha1.Value.TimeOfDay != TimeSpan.Zero)
                                    {
                                        <div class="time-display">
                                            @{
                                                var horas = item.Fecha1.Value.Hour.ToString("D2");
                                                var minutos = item.Fecha1.Value.Minute.ToString("D2");
                                                var periodo = item.Fecha1.Value.Hour < 12 ? "AM" : "PM";
                                            }
                                            <span class="time-digit">@horas[0]</span>
                                            <span class="time-digit">@horas[1]</span>
                                            <span class="time-separator">:</span>
                                            <span class="time-digit">@minutos[0]</span>
                                            <span class="time-digit">@minutos[1]</span>
                                            <span class="time-period">@periodo</span>
                                        </div>
                                    }
                                </div>
                            }
                            @if (showFecha2 && item.Fecha2 != null)
                            {
                                <div class="detail-item">
                                    <label>@labelFecha2:</label>
                                    <span class="date-value">@(item.Fecha2.Value.ToString("dddd dd \\de MMMM \\del yyyy"))</span>
                                    @if (showHora2 && item.Fecha2.Value.TimeOfDay != TimeSpan.Zero)
                                    {
                                        <div class="time-display">
                                            @{
                                                var horas2 = item.Fecha2.Value.Hour.ToString("D2");
                                                var minutos2 = item.Fecha2.Value.Minute.ToString("D2");
                                                var periodo2 = item.Fecha2.Value.Hour < 12 ? "AM" : "PM";
                                            }
                                            <span class="time-digit">@horas2[0]</span>
                                            <span class="time-digit">@horas2[1]</span>
                                            <span class="time-separator">:</span>
                                            <span class="time-digit">@minutos2[0]</span>
                                            <span class="time-digit">@minutos2[1]</span>
                                            <span class="time-period">@periodo2</span>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        <!-- Días y Goce -->
                        <div class="detail-row">
                            <div class="detail-item">
                                <label>Días solicitados:</label>
                                <span class="days-badge">@(item.Dias ?? 0)</span>
                            </div>
                            <div class="detail-item">
                                <label>Goce de pago:</label>
                                <span class="goce-badge goce-@(item.Goce ? "si" : "no")">
                                    @(item.Goce ? "Con goce" : "Sin goce")
                                </span>
                            </div>
                        </div>
                        <!-- Motivo -->
                        @if (!string.IsNullOrEmpty(item.Motivo))
                        {
                            <div class="detail-row full-width">
                                <div class="detail-item">
                                    <label>Motivo de incidencia:</label>
                                    <p class="motivo-text">@item.Motivo</p>
                                </div>
                            </div>
                        }
                        <!-- Fechas del Sistema -->
                        <div class="system-dates">
                            <strong>Creado:</strong> @item.FechaCreacion.ToString("dddd dd \\de MMMM \\del yyyy \\a \\las HH:mm")
                            @if (item.FechaAutorizacion != null)
                            {
                                <br>
                                <strong>Autorizado:</strong>
                                @item.FechaAutorizacion?.ToString("dddd dd \\de MMMM \\del yyyy \\a \\las HH:mm")
                            }
                            @if (item.FechaModificacion != null)
                            {
                                <br>
                                <strong>Modificado:</strong>
                                @item.FechaModificacion?.ToString("dddd dd \\de MMMM \\del yyyy \\a \\las HH:mm")
                            }
                        </div>
                    </div>
                </div>
                <!-- Card Footer -->
                <div class="card-footer">
                    <div class="action-buttons">
                        <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-outline-primary">
                            <i class="fas fa-eye"></i> Ver
                        </a>
                        @if (!isAutorizador)
                        {
                            <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-outline-secondary">
                                <i class="fas fa-edit"></i> Editar
                            </a>
                        }
                    </div>
                </div>
            </div>
        }
    </div>


    <!-- Empty State -->
    @if (!(Model.Permisos?.Any() ?? false))
    {
        <div class="empty-state fade-in">
            <div class="empty-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <h3>No hay permisos registrados</h3>
        </div>
    }
</div>

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approveModalLabel">Aprobar Permiso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de aprobar este permiso?</p>
                <div class="form-group">
                    <label for="approveComments">Comentarios de autorización:</label>
                    <textarea class="form-control" id="approveComments" rows="3" placeholder="Comentarios adicionales (opcional)"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <!-- Botón "Aprobar Permiso" eliminado -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/Permisos/index.js" asp-append-version="true"></script>
}